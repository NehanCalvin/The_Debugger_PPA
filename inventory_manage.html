<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>Raw Inventory Management</title>
        <link rel="stylesheet" href="inventory_manage.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    </head>

    <body>
        <div class="sidebar">
            <a href="admin.html"> Dashboard</a>
            <a href="inventory_create.html"><i class="fas fa-plus-circle"></i> Create Inventory</a>
            <a class="active" href="#"><i class="fas fa-chart-line"></i> Manage Inventory</a>
            <a href="inventory_report.html"><i class="fas fa-file-alt"></i> Reports</a>
        </div>

        <div class="content">
            <h1>Raw Inventory Management</h1>
            <br>
            <div class="search-container">
                <input type="text" id="searchBox" placeholder="Search by Item Name or Supplier..." onkeyup="filterCards()" />
                <i class="fas fa-search search-icon"></i>
            </div>
            <br><br>
            
            <!--Cards-->
            <div id="loadingMessage" class="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading inventory data...
            </div>
            
            <div id="inventoryCards" class="cards-container">
            </div>
        </div>
        
        <!-- Update Popup -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Inventory Item</h2>
                    <span class="close" onclick="closeEditModal()">&times;</span>
                </div>
                <form id="editForm" enctype="multipart/form-data">
                    <input type="hidden" id="editId" name="id">
                    
                    <div class="form-group">
                        <label for="editItemName"><i class="fas fa-file-invoice"></i> Item Name:</label>
                        <input type="text" id="editItemName" name="itemName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editColour"><i class="fa-solid fa-palette"></i> Colour:</label>
                        <input type="text" id="editColour" name="colour" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editRawPrice"><i class="fa-solid fa-sack-dollar"></i> Price per Item (LKR):</label>
                        <input type="number" id="editRawPrice" name="rawprice" step="0.01" min="0.01" required oninput="calculateTotalPrice()">
                    </div>
                    
                    <div class="form-group">
                        <label for="editSupplier"><i class="fas fa-user"></i> Supplier Name:</label>
                        <input type="text" id="editSupplier" name="supplier" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editPhone"><i class="fas fa-phone"></i> Supplier Contact:</label>
                        <input type="tel" id="editPhone" name="phone" pattern="[0-9]{10}" maxlength="10" title="Please enter exactly 10 digits" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editQuantity"><i class="fas fa-sort-numeric-up"></i> Quantity:</label>
                        <input type="number" id="editQuantity" name="quantity" min="1" step="1" required oninput="calculateTotalPrice()">
                    </div>
                    
                    <div class="summary">
                        <p class="total_price">Total Price: <span id="editTotalPrice">0.00</span> LKR</p>
                        <input type="hidden" id="editTotalPriceInput" name="total_price">
                    </div>
                    
                    <div class="form-group">
                        <label for="editImg"><i class="fas fa-image"></i> Update Image:</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="editImg" name="itemImage" accept="image/*" style="display: none;">
                            <button type="button" class="upload-photo-btn-modal" onclick="document.getElementById('editImg').click()">
                                <i class="fas fa-upload"></i> Upload Photo
                            </button>
                        </div>
                        <div id="currentImagePreview" style="margin-top: 10px;"></div>
                        <div id="newImagePreview" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" onclick="closeEditModal()" class="btn-cancel">Cancel</button>
                        <button type="submit" class="btn-save">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
        
        <script>
// Function to format numbers with commas
function formatNumberWithCommas(number) {
    return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

async function fetchInventoryData() {
    const response = await fetch('inventory_fetch.php');
    const inventoryData = await response.json();
    displayInventoryCards(inventoryData);
}

function displayInventoryCards(data) {
    const inventoryCards = document.getElementById('inventoryCards');
    const loadingMessage = document.getElementById('loadingMessage');
    inventoryCards.innerHTML = '';
    loadingMessage.style.display = 'none';

    if (data.length === 0) {
        inventoryCards.innerHTML = '<p>No inventory items found.</p>';
        return;
    }

    data.forEach(item => {
        const card = document.createElement('div');
        card.className = 'inventory-card';
        card.setAttribute('data-item', item.itemName);
        card.setAttribute('data-supplier', item.supplier);

        card.innerHTML = `
            <div class="card-image-container">
                <img src="${item.Img}" alt="Item Image" class="card-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNDQ0Ii8+CjxwYXRoIGQ9Ik0yNSAzNUgzNVYyNUg2NVYzNUg3NVY2NUg2NVY3NUgzNVY2NUgyNVYzNVoiIGZpbGw9IiM4ODgiLz4KPGNpcmNsZSBjeD0iNDUiIGN5PSI0NSIgcj0iOCIgZmlsbD0iIzg4OCIvPgo8L3N2Zz4K'">
            </div>
            <div class="card-content">
                <div class="card-details">
                    <h3 class="item-name">${item.itemName}</h3>
                    <p class="item-info"><span class="label">Colour:</span> ${item.colour}</p>
                    <p class="item-info"><span class="label">Price Per Item:</span> ${formatNumberWithCommas(parseFloat(item.rawprice).toFixed(2))} LKR</p>
                    <p class="item-info"><span class="label">Supplier:</span> ${item.supplier}</p>
                    <p class="item-info"><span class="label">Contact:</span> ${item.phone}</p>
                    <p class="item-info"><span class="label">Qty:</span> ${formatNumberWithCommas(item.quantity)}</p>
                    <p class="item-info total-price"><span class="label">Total Price:</span> ${formatNumberWithCommas(parseFloat(item.total_price).toFixed(2))} LKR</p>
                </div>
                <div class="card-actions">
                    <button class="btn-update" onclick="editItem(${item.id})">Update Stock</button>
                    <button class="btn-delete" onclick="deleteItem(${item.id})">Delete</button>
                </div>
            </div>
        `;

        inventoryCards.appendChild(card);
    });
}

fetchInventoryData();

function filterCards() {
    const searchBox = document.getElementById('searchBox');
    const filter = searchBox.value.toLowerCase();
    const cards = document.getElementsByClassName('inventory-card');
    
    for (let i = 0; i < cards.length; i++) {
        const card = cards[i];
        const itemName = card.getAttribute('data-item').toLowerCase();
        const supplier = card.getAttribute('data-supplier').toLowerCase();
        
        if (itemName.includes(filter) || supplier.includes(filter)) {
            card.style.display = 'flex';
        } else {
            card.style.display = 'none';
        }
    }
}

// Edit functionality
async function editItem(id) {
    try {
        const response = await fetch(`inventory_update.php?id=${id}`);
        const result = await response.json();
        
        if (result.success) {
            const item = result.data;
            
            // Populate the edit form with current data
            document.getElementById('editId').value = item.id;
            document.getElementById('editItemName').value = item.itemName;
            document.getElementById('editColour').value = item.colour;
            document.getElementById('editRawPrice').value = item.rawprice;
            document.getElementById('editSupplier').value = item.supplier;
            document.getElementById('editPhone').value = item.phone;
            document.getElementById('editQuantity').value = item.quantity;
            document.getElementById('editTotalPrice').textContent = formatNumberWithCommas(parseFloat(item.total_price).toFixed(2));
            document.getElementById('editTotalPriceInput').value = item.total_price;
            
            // Clear file input and previews
            document.getElementById('editImg').value = '';
            document.getElementById('newImagePreview').innerHTML = '';
            
            // Show current image
            const currentImagePreview = document.getElementById('currentImagePreview');
            if (item.Img && item.Img !== '') {
                currentImagePreview.innerHTML = `
                    <p style="color: #ccc; font-size: 12px; margin-bottom: 5px;">Current Image:</p>
                    <img src="${item.Img}" alt="Current Image" style="max-width: 200px; max-height: 150px; border-radius: 5px; border: 1px solid #555; background: #3a3a3a;" />
                `;
            } else {
                currentImagePreview.innerHTML = '<p style="color: #ccc; font-size: 12px;">No current image</p>';
            }
            
            // Calculate initial total price
            calculateTotalPrice();
            
            // Show the modal
            document.getElementById('editModal').style.display = 'block';
        } else {
            alert('Error fetching item details: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Image preview functionality for edit form
document.getElementById('editImg').addEventListener('change', function() {
    const file = this.files[0];
    const newImagePreview = document.getElementById('newImagePreview');
    
    if (file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            newImagePreview.innerHTML = `
                <p style="color: #ccc; font-size: 12px; margin-bottom: 5px;">New Image Preview:</p>
                <img src="${e.target.result}" alt="New Image Preview" style="max-width: 200px; max-height: 150px; border-radius: 5px; border: 1px solid #555; background: #3a3a3a;" />
                <p style="margin-top: 5px; font-size: 10px; color: #ccc;">Selected: ${file.name}</p>
            `;
        };
        
        reader.readAsDataURL(file);
    } else {
        newImagePreview.innerHTML = '';
    }
});

// Close modal function
function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

// Handle form submission
document.getElementById('editForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('inventory_update.php', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Item updated successfully!');
            closeEditModal();
            fetchInventoryData(); // Refresh the data
        } else {
            alert('Error updating item: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Delete functionality
async function deleteItem(id) {
    if (confirm('Are you sure you want to delete this item?')) {
        try {
            const formData = new FormData();
            formData.append('id', id);
            
            const response = await fetch('inventory_delete.php', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Item deleted successfully!');
                fetchInventoryData(); // Refresh the data
            } else {
                alert('Error deleting item: ' + result.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
}

// Function to calculate total price automatically
function calculateTotalPrice() {
    const rawPrice = parseFloat(document.getElementById('editRawPrice').value) || 0;
    const quantity = parseFloat(document.getElementById('editQuantity').value) || 0;
    const totalPrice = rawPrice * quantity;
    document.getElementById('editTotalPrice').textContent = formatNumberWithCommas(totalPrice.toFixed(2));
    document.getElementById('editTotalPriceInput').value = totalPrice.toFixed(2);
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target === modal) {
        closeEditModal();
    }
}
        </script>
    </body>
</html>